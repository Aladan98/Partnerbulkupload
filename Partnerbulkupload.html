<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Partnerbulkupload</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    .error { background-color: #f8d7da; }
    #links a, #manualLinks button { display: inline-block; margin: 5px 5px 5px 0; padding: 5px 10px; background: #007BFF; color: white; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; }
    #links a:hover, #manualLinks button:hover { background: #0056b3; }
    #errorSummary { margin-top:10px; color: #c00; font-weight:bold; }
</style>
</head>
<body>

<h1>Partnerbulkupload</h1>
<p>Download master template, fill products, then upload below.</p>
<a href="master_products_template.xlsx" download>Download Master Template</a>
<br><br>
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
<br><br>
<button onclick="processFile()">Generate CSVs</button>

<h2>Preview & Errors</h2>
<div id="errorSummary"></div>
<div id="preview"></div>
<div id="links"></div>
<div id="manualLinks"></div>

<script>
// --- Utility Functions ---
function normalizeHeaders(row) {
    let newRow = {};
    for (let key in row) {
        let newKey = key.toString().trim().replace(/\s+/g, ' ');
        newRow[newKey] = row[key];
    }
    return newRow;
}

function cleanField(str) {
    if(!str) return '';
    return str.toString().trim().replace(/[\r\n]+/g, ' ').replace(/[^\x00-\x7F\u0600-\u06FF ]+/g, '');
}

function validateRow(row, seenSKUs) {
    let errors = [];
    if(!row.SKU) errors.push("Missing SKU");
    if(seenSKUs.has(row.SKU)) errors.push("Duplicate SKU");
    if(!row.Name) errors.push("Missing Name");
    if(!row.Price || isNaN(Number(row.Price.toString().replace(/,/g,'')))) errors.push("Invalid Price");
    if(!row.Category) errors.push("Missing Category");
    if(row['Image URL'] && !/^https?:\/\/\S+\.\S+/.test(row['Image URL'])) errors.push("Invalid Image URL");
    return errors;
}

// --- Dynamic Platform Mapping ---
const platformMap = {
    Talabat: ["Name:Item Name","SKU:SKU","Description:Description","Category:Category","Price:Price","Stock:Stock","Image URL:Image URL"],
    Snoonu: ["Name:Product Name","SKU:SKU","Price:Price","Category:Category","Stock:Stock","Image URL:Image URL"],
    Rafeeq: ["Name:Name","SKU:SKU","Description:Description","Price:Price","Category:Category","Stock:Stock"],
    Bleems: ["Name:Product Name","SKU:SKU","Price:Price","Description:Description","Image URL:Image URL"]
};

// --- Main Function ---
function processFile() {
    const fileInput = document.getElementById('fileInput');
    if(!fileInput.files[0]) { alert("Please select a file!"); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        let rows = [];
        try {
            const file = fileInput.files[0];
            // XLSX parsing
            if(file.name.match(/\.xlsx|\.xls$/i) && typeof XLSX !== "undefined") {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type:'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
            } 
            // CSV parsing
            else if(file.name.match(/\.csv$/i) && typeof Papa !== "undefined") {
                const text = e.target.result;
                const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
                rows = parsed.data;
            } else {
                alert("Unsupported file or missing parsing libraries.");
                return;
            }

            if(rows.length === 0) { alert("No rows found!"); return; }

            // Clean and normalize
            rows = rows.map(r => normalizeHeaders(r));
            rows = rows.map(r => { for(let key in r) r[key]=cleanField(r[key]); return r; });
            rows = rows.filter(r => Object.values(r).some(v=>v!==''));

            // Expand variants/modifiers
            let expanded = [];
            rows.forEach(r=>{
                let variants = r.Variant ? r.Variant.split(',') : [''];
                let modifiers = r.Modifier ? r.Modifier.split(',') : [''];
                variants.forEach(v=>{ modifiers.forEach(m=>{ 
                    let newRow = {...r}; newRow.Variant=v.trim(); newRow.Modifier=m.trim(); expanded.push(newRow); 
                });});
            });

            // Validate
            let seenSKUs = new Set();
            expanded.forEach(r=>{
                r._errors = validateRow(r, seenSKUs);
                if(!r._errors.includes("Duplicate SKU")) seenSKUs.add(r.SKU);
            });

            showPreview(expanded);
            generateCSVs(expanded);
            generateManualCSVs(expanded);

        } catch(err) {
            console.error(err);
            alert("Error processing file. Check console. Fallback: only CSV upload supported if XLSX fails.");
        }
    };

    const file = fileInput.files[0];
    if(file.name.endsWith(".csv")) reader.readAsText(file); else reader.readAsArrayBuffer(file);
}

// --- Preview ---
function showPreview(rows) {
    const previewDiv = document.getElementById('preview');
    const errorDiv = document.getElementById('errorSummary');

    const maxPreview = 100;
    const previewRows = rows.slice(0, maxPreview);

    let totalErrors = rows.filter(r=>r._errors.length>0).length;
    errorDiv.textContent = `Total Rows: ${rows.length}, Errors: ${totalErrors} (Showing first ${maxPreview} rows)`;

    if(rows.length === 0) { previewDiv.innerHTML=''; return; }

    let html = '<table><tr>';
    for(let key in previewRows[0]) if(key!=='_errors') html+='<th>'+key+'</th>';
    html+='<th>Errors</th></tr>';

    previewRows.forEach(r=>{
        html+='<tr>';
        for(let key in r){
            if(key==='_errors') continue;
            html += r._errors.length? `<td class="error">${r[key]}</td>` : `<td>${r[key]}</td>`;
        }
        html+='<td>'+r._errors.join(', ')+'</td>';
        html+='</tr>';
    });

    html+='</table>';
    previewDiv.innerHTML = html;
}

// --- CSV Generation ---
function generateCSVs(rows){
    if(typeof JSZip==="undefined" || typeof Papa==="undefined"){
        console.warn("JSZip or PapaParse missing: only manual CSV download available.");
        return;
    }
    const zip = new JSZip();

    for(let platform in platformMap){
        let mapping = platformMap[platform];
        let transformed = rows.map(r=>{
            let obj={};
            mapping.forEach(m=>{
                const [src,dest] = m.split(':');
                obj[dest] = r[src] || '';
            });
            return obj;
        });
        const csv = Papa.unparse(transformed);
        zip.file(platform+"_products.csv",csv);
    }

    zip.generateAsync({type:"blob"}).then(content=>{
        const linksDiv = document.getElementById('links');
        linksDiv.innerHTML='';
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download="All_Platform_CSVs.zip";
        link.textContent="Download All CSVs (ZIP)";
        linksDiv.appendChild(link);
    });
}

// --- Manual CSV Buttons ---
function generateManualCSVs(rows){
    const manualDiv = document.getElementById('manualLinks');
    manualDiv.innerHTML='';
    for(let platform in platformMap){
        let btn = document.createElement('button');
        btn.textContent = "Download "+platform+" CSV";
        btn.onclick = ()=>{
            let mapping = platformMap[platform];
            let transformed = rows.map(r=>{
                let obj={};
                mapping.forEach(m=>{
                    const [src,dest]=m.split(':');
                    obj[dest]=r[src]||'';
                });
                return obj;
            });
            const csv = Papa.unparse(transformed);
            const blob = new Blob([csv],{type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = platform+"_products.csv";
            a.click();
        };
        manualDiv.appendChild(btn);
    }

    // Errors CSV
    let errorRows = rows.filter(r=>r._errors.length>0).map(r=>{
        let copy = {...r}; copy.Errors=r._errors.join(', '); delete copy._errors; return copy;
    });
    if(errorRows.length>0){
        let btn = document.createElement('button');
        btn.textContent = "Download Errors CSV";
        btn.onclick=()=>{
            const csv = Papa.unparse(errorRows);
            const blob = new Blob([csv],{type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download="errors.csv";
            a.click();
        };
        manualDiv.appendChild(btn);
    }
}
</script>

</body>
</html>
